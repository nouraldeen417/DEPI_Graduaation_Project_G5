pipeline {
    agent any
    environment {
        DOCKER_REGISTRY = "your-docker-registry" // e.g., Docker Hub
        IMAGE_NAME = "your-app-image"
        IMAGE_TAG = "${env.BUILD_ID}"
        REMOTE_USER = "jenkins-remote"
        REMOTE_HOST = "192.168.1.150"
        REMOTE_DIR = "/home/jenkins-remote/"
    }
    stages {
        stage('build docker image') {
            steps {
                
                    sh "ls -l"
                    sh "docker build -t networkapp:$BUILD_NUMBER .   "
                    sh "cd nginx && docker build -t nginx_custom:0 .   "
                    sh "ls -l && pwd"
                    echo 'optional push images in my public regitry '
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'PASS', usernameVariable: 'USER')]) 
                {
                    sh 'docker login -u $USER -p $PASS\
                     && docker tag networkapp:$BUILD_NUMBER nouraldeen152/networkapp:$BUILD_NUMBER\
                     && docker push nouraldeen152/networkapp:$BUILD_NUMBER '
                }
            }
        }       
        stage('test') {
            steps {
                sh "echo test stage"
            }
        }
        stage('deploy') {
            steps {
                sshagent(['jenkins-remote-credentials']) {
                    sh """
                        scp docker-compose.yml ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_DIR}/
                        ssh ${REMOTE_USER}@${REMOTE_HOST} "cd ${REMOTE_DIR}  && BUILD_NUMBER=${BUILD_NUMBER} docker compose up -d"
                    """
                             // some block
                    }       
                    // Ensure BUILD_NUMBER is available for docker-compose
                    // sh "BUILD_NUMBER=${BUILD_NUMBER} docker compose up -d"
            }
        }
    }
}